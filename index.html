<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>全球主要指数 · 10年PE（TTM）走势</title>
  <style>
    :root{ --bg:#0b1220; --card:#0f1724; --fg:#e6eef8; --muted:#98a2b3;}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--fg)}
    header{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.03)}
    h1{margin:0;font-size:20px}
    p.subtitle{margin:6px 0 0;color:var(--muted);font-size:13px}
    main{padding:18px}
    #chart{width:100%;height:68vh;max-height:780px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:8px;padding:12px}
    .footer{padding:12px 24px;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02)}
    .meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .badge{background:#0b2540;color:#8ec1ff;padding:6px 10px;border-radius:999px;font-weight:600;font-size:13px}
    @media (max-width:640px){ #chart{height:56vh} header{padding:12px} main{padding:12px} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>全球主要指数 · 10年 PE（TTM）走势</h1>
        <p class="subtitle">指数：沪深300 (CSI 300) · 纳斯达克综合 (Nasdaq Composite) · 标普500 (S&P 500) · 恒生指数 (HSI)</p>
      </div>
      <div class="meta">
        <div class="badge">自动更新：每日 北京时间 15:00（数据端）</div>
        <div id="last-update" style="color:var(--muted);font-size:13px">上次更新：--</div>
      </div>
    </div>
  </header>

  <main>
    <div id="chart"></div>
  </main>

  <div class="footer" id="footer">
    数据来源：请在 <code>app.py</code> 中配置 API 接口，例如 Nasdaq DataLink 等。<br/>
    更新频率：每个交易日北京时间 15:00 自动更新（GitHub Actions）。
  </div>

<script>
(function(){
  const el = document.getElementById('chart');
  const chart = echarts.init(el, null, {renderer:'canvas', useDirtyRect: true});
  const intervalMilliseconds = 60 * 1000; // 每分钟刷新一次

  // 从 data.json 获取数据
  async function fetchJSON(url){
    try {
      const res = await fetch(url + "?v=" + Date.now(), {cache: "no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (e) {
      console.warn("fetchJSON error", url, e);
      return {};
    }
  }

  async function render(){
    const data = await fetchJSON("data.json");

    // 假设 data.json 结构类似：
    // {
    //   "csi300": {"date": "2025-09-01", "value": 14.23},
    //   "nasdaq": {"date": "2025-09-01", "value": 28.76},
    //   "sp500": {"date": "2025-09-01", "value": 19.34},
    //   "hsi": {"date": "2025-09-01", "value": 11.05},
    //   "last_updated": "2025-09-01T07:00:00Z"
    // }

    const option = {
      backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg') || '#0b1220',
      textStyle: { color: getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#e6eef8'},
      tooltip: {
        trigger: 'axis',
        axisPointer: {type: 'shadow'}
      },
      xAxis: {
        type: 'category',
        data: ["沪深300", "纳斯达克", "标普500", "恒生指数"],
        axisLabel: { color: '#cbd5e1' }
      },
      yAxis: {
        type: 'value',
        name: 'PE（TTM）',
        axisLine: { show: false },
        splitLine: { show: true }
      },
      series: [{
        name: '最新PE',
        type: 'bar',
        data: [
          data.csi300?.value ?? null,
          data.nasdaq?.value ?? null,
          data.sp500?.value ?? null,
          data.hsi?.value ?? null
        ],
        itemStyle: { borderRadius: [6, 6, 0, 0] }
      }]
    };

    chart.setOption(option, {notMerge:true});

    // 更新时间显示
    const lastUpdate = data.last_updated ? new Date(data.last_updated).toLocaleString("zh-CN", {timeZone: "Asia/Shanghai"}) : "暂无数据";
    document.getElementById('last-update').textContent = "上次更新：" + lastUpdate;
  }

  render();
  setInterval(render, intervalMilliseconds);
  window.addEventListener('resize', () => chart.resize());
})();
</script>
</body>
</html>
