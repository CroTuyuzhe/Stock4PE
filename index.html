<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>全球主要指数 · 实时监控</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f1724;
      --muted: #98a2b3;
      --text: #e6eef8;
      --accent: #4a90e2;
      --up: #ff4d4f;   /* 涨 - 红 */
      --down: #29a329; /* 跌 - 绿 */
      --tag-bg: #1c2536;
      --tag-text: #4a90e2;
      --tag-good: #29a329;
      --tag-error: #ff4d4f;
      --tag-warning: #ffa940;
    }
    
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, "PingFang SC", "Microsoft Yahei", "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 28px;
      border-bottom:1px solid rgba(255,255,255,0.04);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header h1{ margin:0; font-size:18px; font-weight:700; }
    #last-updated { color: var(--muted); font-size:13px; }

    /* 切换视图按钮样式 */
    .view-switch-button {
      display: inline-block;
      padding: 8px 16px;
      background-color: var(--accent);
      color: var(--text);
      text-decoration: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .view-switch-button:hover {
      background-color: #3a7bc8;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    main{
      display:grid;
      grid-template-columns: 1fr; /* 默认单列布局 */
      gap: 20px;
      padding: 20px;
      justify-content: center;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* 卡片区域 */
    #cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      width: 100%;
    }

    /* 卡片容器 */
    .card {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: 10px;
      padding: 16px;
      min-height: 160px;
      width: 100%;
      overflow: hidden;
    }

    /* 左侧信息区 */
    .card .left {
      width: 100%;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }

    .index-title {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 8px;
    }
    .index-name {
      font-size:16px;
      font-weight:700;
      letter-spacing:0.2px;
    }
    .change { font-weight:700; font-size:13px; }
    .up { color: var(--up); }
    .down { color: var(--down); }
    .meta { color: var(--muted); font-size:13px; margin-top:4px; }
    .price { font-size:20px; font-weight:800; margin-top:8px; }
    .range { font-size:13px; color: var(--muted); margin-top:8px; }
    .volume { font-size:12px; color: var(--muted); margin-top:4px; }
    .tag {
      display:inline-block;
      padding:4px 10px;
      margin-top:8px;
      font-size:12px;
      border-radius:6px;
      background: var(--tag-bg);
    }
    .tag-good { color: var(--tag-good); }
    .tag-error { color: var(--tag-error); }
    .tag-warning { color: var(--tag-warning); }

    /* 图表区 */
    .chart { 
      width: 100%; 
      height: 160px;
      cursor: pointer;
    }

    #currency-panel {
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }
    .currency-card {
      background: var(--card);
      border-radius:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.03);
      min-height:120px;
    }
    .currency-title { font-weight:700; font-size:14px; color:var(--text); margin-bottom:6px; }
    .currency-chart { width:100%; height:160px; }

    footer {
      padding: 12px 28px;
      color: var(--muted);
      font-size:13px;
      border-top: 1px solid rgba(255,255,255,0.03);
      text-align:center;
    }

    /* 中等屏幕布局 */
    @media (min-width: 900px) {
      main {
        grid-template-columns: 1fr 320px;
      }
      
      .card {
        flex-direction: row;
      }
      
      .card .left {
        flex: 0 0 180px;
        width: auto;
        padding-right: 16px;
      }
      
      .chart {
        flex: 2;
      }
    }

    /* 大屏幕布局 */
    @media (min-width: 1200px) {
      main {
        grid-template-columns: 1fr 420px;
      }
      
      .card .left {
        flex: 0 0 200px;
      }
      
      .chart {
        flex: 2;
      }
    }

    /* 小屏幕适配 */
    @media (max-width: 600px) {
      #cards {
        grid-template-columns: 1fr;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 12px 16px;
      }

      .header-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      main {
        padding: 16px;
      }
      
      .card {
        min-height: auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>全球主要指数 · 实时监控（含 52 周区间）</h1>
      <a href="goods.html" class="view-switch-button">🟡切换视图</a>
    </div>
    <div id="last-updated">⏰ 最近数据更新（伦敦时间）：--</div>
  </header>

  <main>
    <section id="cards" aria-label="指数列表"></section>
    <aside id="currency-panel" aria-label="按币种概览"></aside>
  </main>

  <footer>
    数据来源：由后端生成的 <code>Powered By Eric</code>。页面每 60 秒自动刷新。
  </footer>

<script>
(async function(){
  const fmtPrice = (v) => (v==null || isNaN(v)) ? "—" : Number(v).toFixed(2);
  const fmtPct = (v) => (v==null || isNaN(v)) ? "—" : (v>=0? "+" : "") + v.toFixed(2) + "%";
  const fmtNum = (v) => (v==null || isNaN(v)) ? "—" : new Intl.NumberFormat().format(Number(v));

  let cardCharts = [], currencyCharts = {};

  function normalizeRegion(name, regionField){
    if (/恒生|HSI/i.test(name)) return "中国香港";
    if (/台湾|TWII|Taiwan/i.test(name)) return "中国台湾";
    return regionField || "未知";
  }

  function getQualityTag(dataQuality) {
    switch(dataQuality) {
      case 'good': return { text: '校验数据质量：优秀', class: 'tag-good' };
      case 'error': return { text: '校验数据质量：错误', class: 'tag-error' };
      case 'warning': return { text: '校验数据质量：警告', class: 'tag-warning' };
      default: return { text: '校验数据质量：未知', class: '' };
    }
  }

  function idFor(key){ return "id_" + key.replace(/\s+/g, "_").replace(/[^\w\-]/g, "_"); }

  async function loadAndRender(){
    cardCharts.forEach(ch => { try { ch.dispose(); } catch(e){} });
    cardCharts = [];
    Object.values(currencyCharts).forEach(ch => { try { ch.dispose(); } catch(e){} });
    currencyCharts = {};

    let data;
    try {
      const res = await fetch("data.json?ts=" + Date.now(), {cache:"no-store"});
      data = await res.json();
    } catch (err) {
      console.error("读取失败", err);
      return;
    }

    const lu = data.last_updated || data.lastUpdated;
    if (lu) {
      const dt = new Date(lu);
      document.getElementById("last-updated").textContent = "⏰ 最近数据更新（伦敦时间）：" + dt.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"});
    }

    let keys = Object.keys(data).filter(k=>!["last_updated","lastUpdated"].includes(k));
    keys.sort((a,b)=>{
      const pa = (data[a].currency==="CNY"||data[a].currency==="HKD")?0:1;
      const pb = (data[b].currency==="CNY"||data[b].currency==="HKD")?0:1;
      if(pa!==pb) return pa-pb;
      return a.localeCompare(b,'zh-Hans-CN');
    });

    const cardsEl = document.getElementById("cards");
    cardsEl.innerHTML = "";

    for(const k of keys){
      const it = data[k]||{};
      const region = normalizeRegion(k,it.region);
      const price = it.current_price??null;
      const prev = it.previous_close??null;
      const chg = it.change_percent??null;
      const high = it.fifty_two_week_high??null;
      const low = it.fifty_two_week_low??null;
      const vol = it.volume??null;
      const cur = it.currency??"—";
      const dataQuality = it.data_quality || "unknown";
      const qualityTag = getQualityTag(dataQuality);

      const card=document.createElement("div"); card.className="card";
      const left=document.createElement("div"); left.className="left";

      const headerDiv=document.createElement("div"); headerDiv.className="index-title";
      const nameDiv=document.createElement("div"); nameDiv.className="index-name"; nameDiv.innerText=k;
      const changeDiv=document.createElement("div"); changeDiv.className="change"; changeDiv.innerText=fmtPct(chg);
      changeDiv.classList.add((chg!=null && chg>=0)?"up":"down");
      headerDiv.appendChild(nameDiv); headerDiv.appendChild(changeDiv);

      const priceDiv=document.createElement("div"); priceDiv.className="price"; priceDiv.innerText=(price==null?"—":fmtPrice(price)+" "+cur);

      const prevDiv=document.createElement("div"); prevDiv.className="meta"; prevDiv.innerText="前收盘："+(prev==null?"—":fmtPrice(prev));

      const rangeDiv=document.createElement("div"); rangeDiv.className="range"; rangeDiv.innerText=`52 周：${fmtPrice(low)} — ${fmtPrice(high)}`;

      const metaDiv=document.createElement("div"); metaDiv.className="meta"; metaDiv.innerHTML=`地区：${region} • 成交量：${fmtNum(vol)}`;

      const quality=document.createElement("span"); 
      quality.className=`tag ${qualityTag.class}`; 
      quality.innerText=qualityTag.text;

      left.appendChild(headerDiv);
      left.appendChild(priceDiv);
      left.appendChild(prevDiv);
      left.appendChild(rangeDiv);
      left.appendChild(metaDiv);
      left.appendChild(quality);

      const chartDiv=document.createElement("div"); chartDiv.className="chart"; chartDiv.id=idFor(k);
      card.appendChild(left); card.appendChild(chartDiv); cardsEl.appendChild(card);

      if(price!=null && low!=null && high!=null){
        const ch=echarts.init(chartDiv);
        
        // 配置ECharts选项，实现区域悬停显示信息
        ch.setOption({
          grid:{left:8,right:8,top:8,bottom:18},
          xAxis:{
            type:'category',
            data:['低点','当前','高点'],
            axisLabel:{color:'#cbd5e1',fontSize:12}
          },
          yAxis:{
            type:'value',
            axisLabel:{color:'#cbd5e1',fontSize:12},
            splitLine:{lineStyle:{color:'rgba(255,255,255,0.03)'}}
          },
          series:[{
            type:'line',
            data:[low,price,high],
            symbol:'circle',
            symbolSize:8,
            lineStyle:{color:'rgba(74,144,226,0.95)', width:2},
            itemStyle:{color:'rgba(74,144,226,0.95)'},
            areaStyle:{
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(74,144,226,0.3)' },
                { offset: 1, color: 'rgba(74,144,226,0.05)' }
              ])
            },
            // 启用区域悬停效果
            emphasis: {
              scale: false,
              focus: 'series',
              itemStyle: {
                borderWidth: 2,
                borderColor: '#fff'
              }
            }
          }],
          tooltip: {
            trigger: 'axis',
            triggerOn: 'mousemove|click', // 鼠标移动和点击时都触发
            alwaysShowContent: false,
            backgroundColor: 'rgba(15,23,36,0.95)',
            borderColor: 'rgba(74,144,226,0.5)',
            textStyle: { color: '#e6eef8' },
            formatter: function(params) {
              // 修复：根据数据点索引显示不同的标签
              const labels = ['52周低点', '当前价格', '52周高点'];
              let result = `<div style="font-weight:bold;margin-bottom:5px;">${k}</div>`;
              
              // 遍历所有参数（数据点）
              params.forEach((item, index) => {
                result += `<div>${labels[item.dataIndex]}: <span style="font-weight:bold;color:${item.color}">${fmtPrice(item.value)} ${cur}</span></div>`;
              });
              
              return result;
            },
            axisPointer: {
              type: 'shadow',
              shadowStyle: { color: 'rgba(74,144,226,0.1)' },
              label: {
                backgroundColor: 'rgba(15,23,36,0.9)',
                color: '#e6eef8'
              }
            }
          }
        });
        cardCharts.push(ch);
      }
    }

    window.addEventListener('resize', function() {
      cardCharts.forEach(chart => {
        try { chart.resize(); } catch(e) {}
      });
    });
  }

  await loadAndRender();
  setInterval(loadAndRender,60000);
})();
</script>
</body>
</html>
